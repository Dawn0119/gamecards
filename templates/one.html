{% extends "index.html" %}

{% block title %}å–®å¼µé¡¯ç¤º{% endblock %}

{% block filter %}{% endblock %}

{% block content %}
<h2>é€™å¼µå¡ç‰‡çš„è³‡è¨Š</h2>
<div id="cardResult">
  <p>ğŸ”„ æ­£åœ¨è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
window.onload = () => {
    const base64 = sessionStorage.getItem('uploadedImage');
    if (!base64) {
        console.log("âš ï¸ æ²’æœ‰åœ–ç‰‡å¯è¾¨è­˜");
        return;
    }

    console.log("ğŸ“¤ ç™¼é€è¾¨è­˜è«‹æ±‚...");

    const byteString = atob(base64.split(',')[1]);
    const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    const blob = new Blob([ab], { type: mimeString });
    const file = new File([blob], 'upload.jpg', { type: mimeString });

    const formData = new FormData();
    formData.append('image', file);

    fetch('/match_one', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const result = document.getElementById('cardResult');
        if (result) {
            if (data.images_html && data.text_html) {
                result.innerHTML = `
                    <div class="card-list single-column">
                      <div class="card-item">
                        <div class="card-images">
                          ${data.images_html}
                        </div>
                        <div class="card-text">
                          ${data.text_html}
                        </div>
                      </div>
                    </div>
                `;
            } else if (data.error) {
                result.innerHTML = `<span style="color:red;">${data.error}</span>`;
            } else {
                result.innerHTML = `<span style="color:red;">âŒ è¾¨è­˜å¤±æ•—</span>`;
            }
            sessionStorage.removeItem('uploadedImage');
        }
    })
    .catch(err => {
        console.error('âŒ ç™¼é€è³‡æ–™å¤±æ•—', err);
        const result = document.getElementById('cardResult');
        if (result) result.innerHTML = 'âŒ ç™¼é€è³‡æ–™å¤±æ•—';
    });
};
</script>
{% endblock %}