{% extends "index.html" %}

{% block title %}âŒ• å…¨éƒ¨é¡¯ç¤º{% endblock %}

{% block filter %}
<div class="filter-bar">
  <h2 class="text-lg font-bold mb-2">å¡ç‰‡é¡å‹</h2>
  <div class="button-group">
    <button onclick="filterCards(this, 'å…¨éƒ¨')" class="active">å…¨éƒ¨</button>
    <button onclick="filterCards(this, 'åŒæ­¥')">åŒæ­¥</button>
    <button onclick="filterCards(this, 'è¶…é‡')">è¶…é‡</button>
    <button onclick="filterCards(this, 'èåˆ')">èåˆ</button>
    <button onclick="filterCards(this, 'é€£çµ')">é€£çµ</button>
    <button onclick="filterCards(this, 'é­”æ³•')">é­”æ³•</button>
    <button onclick="filterCards(this, 'é™·é˜±')">é™·é˜±</button>
    <button onclick="filterCards(this, 'æ•ˆæœ')">æ•ˆæœ</button>
    <button onclick="filterCards(this, 'é€šå¸¸')">é€šå¸¸</button>
    <button onclick="filterCards(this, 'å„€å¼')">å„€å¼</button>
    <button onclick="filterCards(this, 'éˆæ“º')">éˆæ“º</button>
  </div>
</div>
{% endblock %}

{% block content %}
<h2>å¤šå¡è¾¨è­˜çµæœ</h2>
<div id="cardResult">
  <p>ğŸ”„ æ­£åœ¨è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
window.onload = () => {
    const base64 = sessionStorage.getItem('uploadedImage');
    if (!base64) {
        console.log("âš ï¸ æ²’æœ‰åœ–ç‰‡å¯è¾¨è­˜");
        return;
    }

    console.log("ğŸ“¤ ç™¼é€è¾¨è­˜è«‹æ±‚ï¼ˆå¤šå¡ï¼‰...");

    const byteString = atob(base64.split(',')[1]);
    const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    const blob = new Blob([ab], { type: mimeString });
    const file = new File([blob], 'upload.jpg', { type: mimeString });

    const formData = new FormData();
    formData.append('image', file);

    fetch('/match_all', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        const result = document.getElementById('cardResult');
        if (result) {
            result.innerHTML = html;
            sessionStorage.removeItem('uploadedImage');
        }
    })
    .catch(err => {
        console.error('âŒ ç™¼é€è³‡æ–™å¤±æ•—', err);
        const result = document.getElementById('cardResult');
        if (result) result.innerHTML = 'âŒ ç™¼é€è³‡æ–™å¤±æ•—';
    });
};

// èƒå–ä¸»åˆ†é¡
function parseCategory(text) {
    const lines = text.split('<br>').map(line => line.trim());
    let typeLine = lines.find(line => line.startsWith('é¡å‹:'));
    if (!typeLine) return 'é€šå¸¸';

    let cardType = typeLine.replace('é¡å‹:', '').trim();

    const CATEGORIES = ['é­”æ³•', 'é™·é˜±'];
    for (const cat of CATEGORIES) {
        if (cardType.includes(cat)) return cat;
    }

    if (cardType.includes('éˆæ“º')) return 'éˆæ“º';

    const special = ['åŒæ­¥', 'è¶…é‡', 'èåˆ', 'é€£çµ', 'å„€å¼'];
    for (const sp of special) {
        if (cardType.includes(sp)) return sp;
    }

    if (cardType.includes('æ€ªç¸')) {
        if (cardType.includes('æ•ˆæœ')) return 'æ•ˆæœ';
        else return 'é€šå¸¸';
    }

    return 'é€šå¸¸';
}

// é¡å‹ç¯©é¸åŠŸèƒ½
function filterCards(button, type) {
    document.querySelectorAll('.filter-bar button').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');

    const cards = document.querySelectorAll('.card-item');
    cards.forEach(card => {
        const text = card.querySelector('.card-text')?.innerHTML || '';
        const category = parseCategory(text);
        if (type === 'å…¨éƒ¨' || category === type) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
