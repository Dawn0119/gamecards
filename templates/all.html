{% extends "index.html" %}

{% block title %}⌕ 全部顯示{% endblock %}

{% block filter %}
<div class="filter-bar">
  <h2 class="text-lg font-bold mb-2">卡片類型</h2>
  <button onclick="filterCards(this, '全部')" class="active">全部</button>
  <button onclick="filterCards(this, '同步')">同步</button>
  <button onclick="filterCards(this, '超量')">超量</button>
  <button onclick="filterCards(this, '融合')">融合</button>
  <button onclick="filterCards(this, '連結')">連結</button>
  <button onclick="filterCards(this, '魔法')">魔法</button>
  <button onclick="filterCards(this, '陷阱')">陷阱</button>
  <button onclick="filterCards(this, '效果')">效果</button>
  <button onclick="filterCards(this, '通常')">通常</button>
  <button onclick="filterCards(this, '儀式')">儀式</button>
  <button onclick="filterCards(this, '靈擺')">靈擺</button>
</div>
{% endblock %}

{% block content %}
<h2>多卡辨識結果</h2>
<div id="cardResult">
  <p>🔄 正在辨識中，請稍候...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
window.onload = () => {
    const base64 = sessionStorage.getItem('uploadedImage');
    if (!base64) {
        console.log("⚠️ 沒有圖片可辨識");
        return;
    }

    console.log("📤 發送辨識請求（多卡）...");

    const byteString = atob(base64.split(',')[1]);
    const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    const blob = new Blob([ab], { type: mimeString });
    const file = new File([blob], 'upload.jpg', { type: mimeString });

    const formData = new FormData();
    formData.append('image', file);

    fetch('/match_all', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        const interval = setInterval(() => {
            const result = document.getElementById('cardResult');
            if (result) {
                result.innerHTML = html;
                clearInterval(interval);
                sessionStorage.removeItem('uploadedImage');
            }
        }, 100);
    })
    .catch(err => {
        console.error('❌ 發送資料失敗', err);
        const result = document.getElementById('cardResult');
        if (result) result.innerHTML = '❌ 發送資料失敗';
    });
};

// 類型篩選功能
function filterCards(button, type) {
    document.querySelectorAll('.filter-bar button').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');

    const cards = document.querySelectorAll('.card-item');
    cards.forEach(card => {
        const text = card.querySelector('.card-text')?.innerText || '';
        const typeLine = text.split('\n').find(line => line.trim().startsWith('類型:'));

        if (type === '全部') {
            card.style.display = 'block';
        } else if (typeLine && typeLine.includes(type)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
