{% extends "index.html" %}

{% block title %}⌕ 自行選擇{% endblock %}

{% block filter %}{% endblock %}

{% block content %}
<h2>自行選擇</h2>

<style>
  #choiceContainer {
    position: relative;
    display: inline-block;
  }
  #choiceImage {
    display: block;
    width: 1000px;
    height: auto;
  }
  .bbox {
    position: absolute;
    border: 2px solid transparent;
    cursor: pointer;
  }
  .bbox:hover {
    border-color: red;
  }
  #hoverPreview {
    position: absolute;
    display: none;
    border: 2px solid white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    width: 200px;
  }
</style>

<div id="choiceContainer">
  <img id="choiceImage" src="/uploads/boxed.jpg">
  <img id="hoverPreview">
</div>

<p>選擇想看的</p>

<script>
  const image = document.getElementById("choiceImage");
  const container = document.getElementById("choiceContainer");
  const popup = document.getElementById("hoverPreview");
  const boxes = JSON.parse('{{ boxes_json | safe }}').predictions;

  image.onload = () => {
    const scaleX = image.clientWidth / image.naturalWidth;
    const scaleY = image.clientHeight / image.naturalHeight;

    boxes.forEach((box, index) => {
      const x = (box.x - box.width / 2) * scaleX;
      const y = (box.y - box.height / 2) * scaleY;
      const w = box.width * scaleX;
      const h = box.height * scaleY;

      const div = document.createElement("div");
      div.className = "bbox";
      Object.assign(div.style, {
        left: `${x}px`,
        top: `${y}px`,
        width: `${w}px`,
        height: `${h}px`
      });

      div.onmouseenter = (e) => {
        popup.src = `/uploads/crop_${index}.jpg?t=${Date.now()}`;
        popup.style.display = "block";
        popup.style.left = `${e.pageX + 20}px`;
        popup.style.top = `${e.pageY + 20}px`;
      };
      div.onmousemove = (e) => {
        popup.style.left = `${e.pageX + 20}px`;
        popup.style.top = `${e.pageY + 20}px`;
      };
      div.onmouseleave = () => {
        popup.style.display = "none";
      };
      
      div.onclick = () => {
        // Hide UI elements
        image.style.display = "none";
        popup.style.display = "none";
        document.querySelector("h2").style.display = "none";
        document.querySelector("p").style.display = "none";
        document.querySelectorAll(".bbox").forEach(box => {
          box.style.display = "none";
        });

        // Show loading message container
        const statusBox = document.createElement("div");
        statusBox.id = "resultBox";
        statusBox.innerHTML = `<span style="color:#00e0ff; font-size: 20px;">🔍 正在辨識中，請稍候...</span>`;
        statusBox.style.marginTop = "40px";
        // statusBox.style.textAlign = "center";
        container.appendChild(statusBox);

        // Fetch match result
        fetch("/match_choice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ index })
        })
        .then(res => res.json())
        .then(data => {
          if (data.result) {
            statusBox.innerHTML = `
              <div class="card-list">
                <div class="card-item">
                  <div class="card-text">
                    ✅ 辨識完成：
                    ${data.result}
                  </div>
                </div>
              </div>`;
          } else {
            statusBox.innerHTML = `<span style="color:red; font-size: 20px;">❌ 辨識失敗，請重試</span>`;
          }
        })

        .catch(err => {
          console.error(err);
          statusBox.innerHTML = `<span style="color:red; font-size: 20px;">❌ 傳送錯誤</span>`;
        });
      };



      container.appendChild(div);
    });
  };
</script>
{% endblock %}
